name: Android Plugin Tests

on:
  push:
    branches: [main]
    paths:
      - 'devbox/plugins/android/**'
      - 'devbox/examples/android/**'
  pull_request:
    paths:
      - 'devbox/plugins/android/**'
      - 'devbox/examples/android/**'

jobs:
  test-device-management:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Devbox
        uses: jetify-com/devbox-install-action@v0.11.0

      - name: Run device management tests
        run: bash devbox/plugins/tests/android/test-device-mgmt.sh

      - name: Run validation tests
        run: bash devbox/plugins/tests/android/test-validation.sh

  test-emulator-lifecycle:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Devbox
        uses: jetify-com/devbox-install-action@v0.11.0

      - name: Test emulator start/stop
        working-directory: devbox/examples/android
        run: |
          # Start emulator in headless mode
          EMU_HEADLESS=1 devbox run --pure start-emu max &
          EMU_PID=$!

          # Wait for emulator to boot
          sleep 45

          # Check if emulator is running
          devbox run --pure android.sh info

          # Stop emulator
          kill $EMU_PID 2>/dev/null || true
          wait $EMU_PID 2>/dev/null || true
