version: "0.5"

# Development mode: Fast iteration with hot reload
# - Uses Debug build for faster compilation
# - Reuses existing emulator if available
# - Keeps Metro and emulator running for hot reload
# - TUI enabled for interactive development

environment:
  - "ANDROID_SERIAL=emulator-5554"
  - "BOOT_TIMEOUT=180"

log_location: "reports/react-native-android-dev-logs"
log_level: info
is_strict: false  # Allow graceful exit

processes:
  # Phase 0: Allocate Metro port
  allocate-metro-port:
    command: |
      . ${REACT_NATIVE_VIRTENV}/scripts/lib/lib.sh
      metro_port=$(rn_allocate_metro_port "android")
      echo "ðŸ“¡ Allocated Metro port: $metro_port"
      env_file=$(rn_save_metro_env "android" "$metro_port")
      echo "âœ“ Metro environment saved to: $env_file"
    availability:
      restart: "no"

  # Phase 1: Build Node dependencies
  build-node:
    depends_on:
      allocate-metro-port:
        condition: process_completed_successfully
    command: "devbox run --pure build:node"
    availability:
      restart: "no"

  # Phase 2: Build Android app (Debug)
  build-android:
    command: |
      . ${ANDROID_RUNTIME_DIR}/scripts/init/setup.sh
      echo 'ðŸ“¦ Building Android app (Debug)...'
      cd android && gradle assembleDebug
      echo 'âœ“ Build complete'
    depends_on:
      build-node:
        condition: process_completed_successfully
    availability:
      restart: "no"

  # Phase 3: Sync AVDs
  sync-avds:
    command: |
      . ${ANDROID_RUNTIME_DIR}/scripts/init/setup.sh
      echo 'ðŸ”„ Syncing AVDs with device definitions...'
      android.sh devices sync
      echo 'âœ“ Sync complete'
    availability:
      restart: "no"

  # Phase 4: Start emulator (reuses if already running)
  android-emulator:
    depends_on:
      sync-avds:
        condition: process_completed_successfully
    command: |
      . ${ANDROID_RUNTIME_DIR}/scripts/init/setup.sh
      device="${ANDROID_DEFAULT_DEVICE:-max}"
      serial="emulator-5554"
      echo "$serial" > ${ANDROID_RUNTIME_DIR}/emulator-serial.txt

      if adb devices | grep -q "$serial"; then
        echo "âœ“ Emulator already running: $serial"
      else
        echo "ðŸš€ Starting emulator: $device"
        android.sh emulator start "$device" &
        echo "âœ“ Emulator starting (PID: $!)"

        echo "Waiting for emulator to boot..."
        max_attempts=60
        attempt=0
        while [ $attempt -lt $max_attempts ]; do
          if adb -s $serial shell getprop sys.boot_completed 2>/dev/null | grep -q "1"; then
            echo "âœ“ Emulator ready for development"
            break
          fi
          attempt=$((attempt + 1))
          sleep 2
        done

        if [ $attempt -ge $max_attempts ]; then
          echo "ERROR: Emulator did not boot within timeout"
          exit 1
        fi
      fi

      echo "âœ“ Emulator will remain running for hot reload"
      exit 0
    availability:
      restart: "no"
    readiness_probe:
      exec:
        command: |
          . ${ANDROID_RUNTIME_DIR}/scripts/init/setup.sh
          serial=$(cat ${ANDROID_RUNTIME_DIR}/emulator-serial.txt 2>/dev/null || echo "")
          [ -n "$serial" ] && adb -s $serial shell getprop sys.boot_completed 2>/dev/null | grep -q "1"
      initial_delay_seconds: 10
      period_seconds: 10
      timeout_seconds: 180
      success_threshold: 1
      failure_threshold: 12

  # Phase 5: Start Metro bundler with hot reload
  metro-bundler:
    command: "metro.sh start android"
    depends_on:
      allocate-metro-port:
        condition: process_completed_successfully
      build-node:
        condition: process_completed_successfully
    availability:
      restart: "on_failure"
      max_restarts: 3
    shutdown:
      command: "metro.sh stop android || true"
      signal: 15
      timeout_seconds: 5
    readiness_probe:
      exec:
        command: "metro.sh health android android"
      initial_delay_seconds: 5
      period_seconds: 5
      timeout_seconds: 60
      success_threshold: 1

  # Phase 6: Deploy app (Debug build for fast iteration)
  deploy-android:
    command: |
      . ${REACT_NATIVE_VIRTENV}/metro/env-android.sh
      echo "ðŸ“² Deploying React Native app (Debug, Metro port: $METRO_PORT)..."
      npx react-native run-android --no-packager
      echo ""
      echo "âœ“ App deployed!"
      echo "  Metro: http://localhost:$METRO_PORT"
      echo "  Hot reload enabled - edit code and save to see changes"
    depends_on:
      build-android:
        condition: process_completed_successfully
      android-emulator:
        condition: process_completed_successfully
      metro-bundler:
        condition: process_healthy
    availability:
      restart: "no"
