version: "0.5"

environment:
  - "TEST_TUI=false"
  - "ANDROID_SERIAL=emulator-5554"
  - "TEST_TIMEOUT=300"
  - "BOOT_TIMEOUT=180"

log_location: "reports/react-native-android-e2e-logs"
log_level: info

processes:
  # Phase 0: Allocate Metro port (runs first, no dependencies)
  allocate-metro-port:
    command: |
      # Source React Native lib
      . ${REACT_NATIVE_VIRTENV}/react-native/scripts/lib/lib.sh

      # Allocate port for android test suite
      metro_port=$(rn_allocate_metro_port "android")
      echo "ðŸ“¡ Allocated Metro port: $metro_port"

      # Save environment file for other processes
      env_file=$(rn_save_metro_env "android" "$metro_port")
      echo "âœ“ Metro environment saved to: $env_file"
    availability:
      restart: "no"

  # Phase 1: Build Node dependencies
  build-node:
    depends_on:
      allocate-metro-port:
        condition: process_completed_successfully
    command: "devbox run --pure build:node"
    availability:
      restart: "no"

  # Phase 2: Build Android app
  build-android:
    command: |
      # Source Android environment
      . ${ANDROID_RUNTIME_DIR}/scripts/init/setup.sh
      echo 'ðŸ“¦ Building Android app...'
      cd android && gradle assembleDebug
      echo 'âœ“ Build complete'
    depends_on:
      build-node:
        condition: process_completed_successfully
    availability:
      restart: "no"

  # Phase 3: Sync AVDs
  sync-avds:
    command: |
      . ${ANDROID_RUNTIME_DIR}/scripts/init/setup.sh
      echo 'ðŸ”„ Syncing AVDs with device definitions...'
      android.sh devices sync
      echo 'âœ“ Sync complete'
    availability:
      restart: "no"

  # Phase 4: Start emulator
  android-emulator:
    depends_on:
      sync-avds:
        condition: process_completed_successfully
    environment:
      - "ANDROID_EMULATOR_FOREGROUND=1"
    command: |
      echo "[ANDROID-EMULATOR] Starting emulator..."
      # Source Android environment
      . ${ANDROID_RUNTIME_DIR}/scripts/init/setup.sh

      device="${ANDROID_DEFAULT_DEVICE:-max}"

      if [ "${IN_NIX_SHELL:-}" = "pure" ]; then
        echo "ðŸš€ Starting fresh Android emulator (pure mode): $device"
        export ANDROID_EMULATOR_PURE=1
        echo "emulator-5554" > ${ANDROID_RUNTIME_DIR}/emulator-serial.txt
        android.sh emulator start "$device"
      else
        echo "ðŸš€ Verifying Android emulator is running: $device"
        serial="emulator-5554"
        echo "$serial" > ${ANDROID_RUNTIME_DIR}/emulator-serial.txt

        if adb devices | grep -q "$serial"; then
          echo "âœ“ Emulator already running: $serial"
        else
          echo "Starting emulator in background: $device"
          unset ANDROID_EMULATOR_FOREGROUND
          android.sh emulator start "$device" &
          echo "âœ“ Emulator starting (PID: $!)"
        fi

        echo "Waiting for emulator to boot..."
        max_attempts=60
        attempt=0
        while [ $attempt -lt $max_attempts ]; do
          if adb -s $serial shell getprop sys.boot_completed 2>/dev/null | grep -q "1"; then
            echo "âœ“ Emulator ready for testing"
            break
          fi
          attempt=$((attempt + 1))
          sleep 2
        done

        if [ $attempt -ge $max_attempts ]; then
          echo "ERROR: Emulator did not boot within timeout"
          exit 1
        fi

        echo "âœ“ Emulator will remain running after tests complete"
        exit 0
      fi
    availability:
      restart: "no"
    readiness_probe:
      exec:
        command: |
          . ${ANDROID_RUNTIME_DIR}/scripts/init/setup.sh
          serial=$(cat ${ANDROID_RUNTIME_DIR}/emulator-serial.txt 2>/dev/null || echo "")
          [ -n "$serial" ] && adb -s $serial shell getprop sys.boot_completed 2>/dev/null | grep -q "1"
      initial_delay_seconds: 10
      period_seconds: 10
      timeout_seconds: 180
      success_threshold: 1
      failure_threshold: 12

  # Phase 5: Start Metro bundler
  metro-bundler:
    command: |
      # Source Metro environment (load allocated port)
      . ${REACT_NATIVE_VIRTENV}/metro/env-android.sh

      echo "ðŸš€ Starting Metro bundler on port $METRO_PORT"
      echo "   Cache dir: ${METRO_CACHE_DIR}"

      # Start Metro with isolated cache and allocated port
      npx react-native start \
        --port $METRO_PORT \
        --reset-cache
    depends_on:
      allocate-metro-port:
        condition: process_completed_successfully
      build-node:
        condition: process_completed_successfully
    availability:
      restart: "on_failure"
      max_restarts: 2
    readiness_probe:
      exec:
        command: |
          # Source Metro environment to get correct port
          . ${REACT_NATIVE_VIRTENV}/metro/env-android.sh

          # Check if Metro server is up on allocated port
          curl -sf http://localhost:$METRO_PORT/status >/dev/null || exit 1

          # Verify Metro can actually serve the bundle (without downloading it)
          curl -sf -I "http://localhost:$METRO_PORT/index.bundle?platform=android&dev=true" | grep -q "HTTP.*200" || exit 1
      initial_delay_seconds: 5
      period_seconds: 5
      timeout_seconds: 60
      success_threshold: 1

  # Phase 6: Deploy app
  deploy-android:
    command: |
      # Source Metro environment so React Native uses correct port
      . ${REACT_NATIVE_VIRTENV}/metro/env-android.sh

      echo "ðŸ“² Deploying React Native app (Metro port: $METRO_PORT)..."
      npx react-native run-android --no-packager
    depends_on:
      build-android:
        condition: process_completed_successfully
      android-emulator:
        condition: process_completed_successfully
      metro-bundler:
        condition: process_healthy
    availability:
      restart: "no"

  # Phase 7: Verify app is running
  verify-app-running:
    command: |
      . ${ANDROID_RUNTIME_DIR}/scripts/init/setup.sh
      serial=$(cat ${ANDROID_RUNTIME_DIR}/emulator-serial.txt 2>/dev/null || echo emulator-5554)

      echo "Waiting for app to start..."
      max_attempts=10
      attempt=0
      while [ $attempt -lt $max_attempts ]; do
        if adb -s $serial shell pidof ${ANDROID_APP_ID:-com.reactnativeexample} >/dev/null 2>&1; then
          echo "âœ“ App process running (PID: $(adb -s $serial shell pidof ${ANDROID_APP_ID:-com.reactnativeexample}))"
          exit 0
        fi
        attempt=$((attempt + 1))
        echo "  Attempt $attempt/$max_attempts..."
        sleep 2
      done

      echo "ERROR: App did not start within timeout" >&2
      exit 1
    depends_on:
      deploy-android:
        condition: process_completed_successfully
    availability:
      restart: "no"

  # Cleanup
  cleanup:
    command: |
      . ${ANDROID_RUNTIME_DIR}/scripts/init/setup.sh
      . ${REACT_NATIVE_VIRTENV}/react-native/scripts/lib/lib.sh

      serial=$(cat ${ANDROID_RUNTIME_DIR}/emulator-serial.txt 2>/dev/null || echo emulator-5554)

      # Note: Process-compose will automatically kill Metro when tests complete
      # We only clean Metro state files here
      echo "ðŸ§¹ Cleaning Metro state files..."
      rm -f ${REACT_NATIVE_VIRTENV}/metro/port-android.txt
      rm -f ${REACT_NATIVE_VIRTENV}/metro/env-android.sh

      if [ "${IN_NIX_SHELL:-}" = "pure" ]; then
        echo "ðŸ§¹ Cleaning up (pure mode)..."
        adb -s $serial shell am force-stop ${ANDROID_APP_ID:-com.reactnativeexample} 2>/dev/null || true
        android.sh emulator stop || true
        echo "âœ“ App stopped, emulator stopped, Metro state cleaned"
      else
        echo "âœ“ Test complete - app and emulator still running, Metro state cleaned"
      fi
    depends_on:
      verify-app-running:
        condition: process_completed
    availability:
      restart: "no"
