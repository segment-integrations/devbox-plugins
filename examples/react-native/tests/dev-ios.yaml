version: "0.5"

# Development mode: Fast iteration with hot reload
# - Uses Debug build for faster compilation
# - Reuses existing simulator if available
# - Keeps Metro and simulator running for hot reload
# - TUI enabled for interactive development

environment:
  - "IOS_DEVICE=${IOS_DEFAULT_DEVICE:-max}"
  - "BOOT_TIMEOUT=120"
  - "ANDROID_SKIP_DOWNLOADS=1"
  - "LANG=en_US.UTF-8"
  - "LC_ALL=en_US.UTF-8"
  - "REACT_NATIVE_VIRTENV=${REACT_NATIVE_VIRTENV}"

log_location: "reports/react-native-ios-dev-logs"
log_level: info
is_strict: false  # Allow graceful exit

processes:
  # Phase 0: Allocate Metro port
  allocate-metro-port:
    command: |
      . ${REACT_NATIVE_VIRTENV}/scripts/lib/lib.sh
      metro_port=$(rn_allocate_metro_port "ios")
      echo "ðŸ“¡ Allocated Metro port: $metro_port"
      env_file=$(rn_save_metro_env "ios" "$metro_port")
      echo "âœ“ Metro environment saved to: $env_file"
    availability:
      restart: "no"

  # Phase 1: Build Node dependencies
  build-node:
    depends_on:
      allocate-metro-port:
        condition: process_completed_successfully
    command: "devbox run --pure build:node"
    availability:
      restart: "no"

  # Phase 2: Install CocoaPods dependencies
  install-pods:
    command: |
      cd ios
      echo "Installing CocoaPods dependencies..."
      pod install --repo-update
      echo 'âœ“ Pod install complete'
    depends_on:
      build-node:
        condition: process_completed_successfully
    availability:
      restart: "no"

  # Phase 3: Sync simulators
  sync-simulators:
    command: "devbox run ios.sh devices sync"
    availability:
      restart: "no"

  # Phase 4: Start simulator (reuses if already running)
  ios-simulator:
    command: |
      echo "ðŸš€ Starting iOS simulator (${IOS_DEVICE})..."
      ios.sh simulator start ${IOS_DEVICE}

      echo "Waiting for simulator to boot..."
      DEVICE_UDID=$(xcrun simctl list devices | grep "Booted" | grep -oE '[0-9A-F-]{36}' | head -1 || echo "")
      if [ -z "$DEVICE_UDID" ]; then
        echo "ERROR: No booted simulator found"
        exit 1
      fi
      xcrun simctl bootstatus "$DEVICE_UDID" >/dev/null 2>&1 || true

      echo "âœ“ Simulator ready for development"
      echo "âœ“ Simulator will remain running for hot reload"
      exit 0
    depends_on:
      sync-simulators:
        condition: process_completed_successfully
    availability:
      restart: "no"
    readiness_probe:
      exec:
        command: |
          DEVICE_UDID=$(xcrun simctl list devices | grep "Booted" | grep -oE '[0-9A-F-]{36}' | head -1 || echo "")
          [ -n "$DEVICE_UDID" ] && xcrun simctl bootstatus "$DEVICE_UDID" >/dev/null 2>&1
      initial_delay_seconds: 10
      period_seconds: 5
      timeout_seconds: 120
      success_threshold: 1
      failure_threshold: 3

  # Phase 5: Start Metro bundler with hot reload
  metro-bundler:
    command: "metro.sh start ios"
    depends_on:
      allocate-metro-port:
        condition: process_completed_successfully
      build-node:
        condition: process_completed_successfully
    availability:
      restart: "on_failure"
      max_restarts: 3
    shutdown:
      command: "metro.sh stop ios || true"
      signal: 15
      timeout_seconds: 5
    readiness_probe:
      exec:
        command: "metro.sh health ios ios"
      initial_delay_seconds: 5
      period_seconds: 5
      timeout_seconds: 60
      success_threshold: 1

  # Phase 6: Build and deploy app (Debug for fast iteration)
  deploy-ios:
    command: |
      set -e

      # Use Debug build for fast compilation
      BUILD_CONFIG="Debug"

      PROJECT_ROOT="${DEVBOX_PROJECT_ROOT:-$(pwd)}"
      echo "ðŸ“² Building React Native app (Debug)"
      echo "Build configuration: $BUILD_CONFIG"

      . ${REACT_NATIVE_VIRTENV}/metro/env-ios.sh
      echo "Metro port: $METRO_PORT"

      # Get simulator UDID
      max_attempts=15
      attempt=0
      DEVICE_UDID=""
      while [ $attempt -lt $max_attempts ] && [ -z "$DEVICE_UDID" ]; do
        DEVICE_UDID=$(xcrun simctl list devices | grep "Booted" | grep -oE '[0-9A-F-]{36}' | head -1 || echo "")
        if [ -z "$DEVICE_UDID" ]; then
          attempt=$((attempt + 1))
          echo "Waiting for simulator... (attempt $attempt/$max_attempts)"
          sleep 2
        fi
      done

      if [ -z "$DEVICE_UDID" ]; then
        echo "ERROR: No booted simulator found"
        exit 1
      fi

      echo "Building for simulator: $DEVICE_UDID"

      DERIVED_DATA_PATH="$PROJECT_ROOT/.devbox/virtenv/ios/DerivedData"
      mkdir -p "$DERIVED_DATA_PATH"

      # Build with xcodebuild (Debug for fast iteration)
      (
        cd ios
        env -u LD -u LDFLAGS -u NIX_LDFLAGS -u NIX_CFLAGS_COMPILE -u NIX_CFLAGS_LINK \
          NODE_BINARY="$NODE_BINARY" \
          RCT_METRO_PORT="$METRO_PORT" \
          xcodebuild \
          -workspace ReactNativeExample.xcworkspace \
          -scheme ${IOS_APP_SCHEME} \
          -configuration "$BUILD_CONFIG" \
          -destination "id=$DEVICE_UDID" \
          -derivedDataPath "$DERIVED_DATA_PATH" \
          -quiet \
          build
      )

      # Install the built app
      echo "Installing app to simulator..."
      APP_PATH="${DEVBOX_PROJECT_ROOT}/.devbox/virtenv/ios/DerivedData/Build/Products/Debug-iphonesimulator/ReactNativeExample.app"

      if [ ! -d "$APP_PATH" ]; then
        echo "ERROR: App bundle not found at $APP_PATH"
        exit 1
      fi

      xcrun simctl install "$DEVICE_UDID" "$APP_PATH"

      # Launch app with Metro port
      echo "Launching app with Metro on port $METRO_PORT..."
      xcrun simctl launch "$DEVICE_UDID" "${IOS_APP_BUNDLE_ID}" \
        RCT_METRO_PORT="$METRO_PORT"

      echo ""
      echo "âœ“ App deployed and running!"
      echo "  Metro: http://localhost:$METRO_PORT"
      echo "  Hot reload enabled - edit code and save to see changes"
    depends_on:
      install-pods:
        condition: process_completed_successfully
      ios-simulator:
        condition: process_completed_successfully
      metro-bundler:
        condition: process_healthy
    availability:
      restart: "no"
