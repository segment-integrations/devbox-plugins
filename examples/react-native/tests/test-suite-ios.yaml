version: "0.5"

environment:
  - "IOS_DEVICE=${IOS_DEFAULT_DEVICE:-max}"
  - "TEST_TIMEOUT=300"
  - "BOOT_TIMEOUT=120"
  - "ANDROID_SKIP_DOWNLOADS=1"
  - "TEST_TUI=false"
  - "LANG=en_US.UTF-8"
  - "LC_ALL=en_US.UTF-8"
  - "REACT_NATIVE_VIRTENV=${REACT_NATIVE_VIRTENV}"
  - "IOS_BUILD_CONFIG=${IOS_BUILD_CONFIG:-Release}"

log_location: "reports/react-native-ios-e2e-logs"
log_level: info
is_strict: true

processes:
  # Phase 0: Allocate Metro port (runs first, no dependencies)
  allocate-metro-port:
    command: |
      # Source React Native lib
      . ${REACT_NATIVE_VIRTENV}/scripts/lib/lib.sh

      # Allocate port for ios test suite
      metro_port=$(rn_allocate_metro_port "ios")
      echo "ðŸ“¡ Allocated Metro port: $metro_port"

      # Save environment file for other processes
      env_file=$(rn_save_metro_env "ios" "$metro_port")
      echo "âœ“ Metro environment saved to: $env_file"
    availability:
      restart: "no"

  # Phase 1: Build Node dependencies
  build-node:
    depends_on:
      allocate-metro-port:
        condition: process_completed_successfully
    command: "devbox run --pure build:node"
    availability:
      restart: "no"

  # Phase 2: Install CocoaPods dependencies
  install-pods:
    command: |
      cd ios
      echo "Installing CocoaPods dependencies..."
      pod install --repo-update
      echo 'âœ“ Pod install complete'
    depends_on:
      build-node:
        condition: process_completed_successfully
    availability:
      restart: "no"

  # Phase 3: Sync simulators
  sync-simulators:
    command: "devbox run ios.sh devices sync"
    availability:
      restart: "no"

  # Phase 4: Start simulator
  ios-simulator:
    command: |
      mkdir -p .devbox/virtenv/ios/runtime

      if [ "${DEVBOX_PURE_SHELL:-}" = "1" ]; then
        echo "ðŸš€ Starting fresh iOS simulator with clean state (${IOS_DEVICE})..."
        output=$(ios.sh simulator start --pure ${IOS_DEVICE} 2>&1)
        echo "$output"

        test_udid=$(echo "$output" | grep -oE '[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}' | tail -1)
        if [ -n "$test_udid" ]; then
          echo "$test_udid" > .devbox/virtenv/ios/runtime/simulator-udid.txt
          echo "âœ“ Test simulator UDID saved: $test_udid"
        fi

        echo "âœ“ Test simulator ready for testing"
        exit 0
      else
        echo "ðŸš€ Starting iOS simulator (${IOS_DEVICE})..."
        ios.sh simulator start ${IOS_DEVICE}

        echo "Waiting for simulator to boot..."
        DEVICE_UDID=$(xcrun simctl list devices | grep "Booted" | grep -oE '[0-9A-F-]{36}' | head -1 || echo "")
        if [ -z "$DEVICE_UDID" ]; then
          echo "ERROR: No booted simulator found"
          exit 1
        fi
        xcrun simctl bootstatus "$DEVICE_UDID" >/dev/null 2>&1 || true

        echo "âœ“ Simulator ready for testing"
        echo "âœ“ Simulator will remain running after tests complete"
        exit 0
      fi
    depends_on:
      sync-simulators:
        condition: process_completed_successfully
    availability:
      restart: "no"
    readiness_probe:
      exec:
        command: |
          if [ "${DEVBOX_PURE_SHELL:-}" = "1" ]; then
            DEVICE_UDID=$(xcrun simctl list devices | grep "Test" | grep "Booted" | grep -oE '[0-9A-F-]{36}' | head -1 || echo "")
          else
            DEVICE_UDID=$(xcrun simctl list devices | grep "Booted" | grep -oE '[0-9A-F-]{36}' | head -1 || echo "")
          fi
          [ -n "$DEVICE_UDID" ] && xcrun simctl bootstatus "$DEVICE_UDID" >/dev/null 2>&1
      initial_delay_seconds: 10
      period_seconds: 5
      timeout_seconds: 120
      success_threshold: 1
      failure_threshold: 3

  # Phase 5: Start Metro bundler
  metro-bundler:
    command: |
      # Source Metro environment (load allocated port)
      . ${REACT_NATIVE_VIRTENV}/metro/env-ios.sh

      echo "ðŸš€ Starting Metro bundler on port $METRO_PORT"
      echo "   Cache dir: ${METRO_CACHE_DIR}"

      # Start Metro with isolated cache and allocated port
      npx react-native start \
        --port $METRO_PORT \
        --reset-cache
    depends_on:
      allocate-metro-port:
        condition: process_completed_successfully
      build-node:
        condition: process_completed_successfully
    availability:
      restart: "on_failure"
      max_restarts: 2

  # Phase 6: Build and deploy app with xcodebuild
  deploy-ios:
    command: |
      set -e

      # Set build configuration (default to Release for E2E tests)
      BUILD_CONFIG="Release"
      test -n "${IOS_BUILD_CONFIG:-}" && BUILD_CONFIG="$IOS_BUILD_CONFIG"

      # Get absolute project root path
      PROJECT_ROOT="${DEVBOX_PROJECT_ROOT:-}"
      test -z "$PROJECT_ROOT" && PROJECT_ROOT="$(pwd)"

      echo "ðŸ“² Building React Native app"
      echo "Build configuration: $BUILD_CONFIG"
      echo "Project root: $PROJECT_ROOT"

      # Validate critical variables early
      test -z "$BUILD_CONFIG" && { echo "ERROR: BUILD_CONFIG is empty!" >&2; exit 1; }
      test -z "$PROJECT_ROOT" && { echo "ERROR: PROJECT_ROOT is empty!" >&2; exit 1; }

      # Source Metro environment so React Native uses correct port
      . ${REACT_NATIVE_VIRTENV}/metro/env-ios.sh
      echo "Metro port: $METRO_PORT"

      # Get simulator UDID (retry for up to 30 seconds)
      max_attempts=15
      attempt=0
      DEVICE_UDID=""

      while [ $attempt -lt $max_attempts ] && [ -z "$DEVICE_UDID" ]; do
        if [ "${DEVBOX_PURE_SHELL:-}" = "1" ]; then
          DEVICE_UDID=$(xcrun simctl list devices | grep "Test" | grep "Booted" | grep -oE '[0-9A-F-]{36}' | head -1 || echo "")
        else
          DEVICE_UDID=$(xcrun simctl list devices | grep "Booted" | grep -oE '[0-9A-F-]{36}' | head -1 || echo "")
        fi

        if [ -z "$DEVICE_UDID" ]; then
          attempt=$((attempt + 1))
          echo "Waiting for simulator to boot... (attempt $attempt/$max_attempts)"
          sleep 2
        fi
      done

      if [ -z "$DEVICE_UDID" ]; then
        echo "ERROR: No booted simulator found after $max_attempts attempts" >&2
        echo "Available devices:" >&2
        xcrun simctl list devices >&2
        exit 1
      fi

      echo "Building for simulator: $DEVICE_UDID"

      # Build with xcodebuild
      # Remove Nix-specific flags that interfere with Apple toolchain
      # NODE_BINARY is set by React Native plugin init hook
      # Pass RCT_METRO_PORT so the app connects to the correct Metro instance

      DERIVED_DATA_PATH="$PROJECT_ROOT/.devbox/virtenv/ios/DerivedData"
      echo "Derived data path: $DERIVED_DATA_PATH"

      # Ensure the derived data directory exists
      mkdir -p "$DERIVED_DATA_PATH"

      # Build with xcodebuild in a subshell to preserve variables
      (
        cd ios
        env -u LD -u LDFLAGS -u NIX_LDFLAGS -u NIX_CFLAGS_COMPILE -u NIX_CFLAGS_LINK \
          NODE_BINARY="$NODE_BINARY" \
          RCT_METRO_PORT="$METRO_PORT" \
          xcodebuild \
          -workspace ReactNativeExample.xcworkspace \
          -scheme ${IOS_APP_SCHEME} \
          -configuration "$BUILD_CONFIG" \
          -destination "id=$DEVICE_UDID" \
          -derivedDataPath "$DERIVED_DATA_PATH" \
          -quiet \
          build
      )

      # Install the built app
      echo "Installing app to simulator..."
      echo "DEBUG: BUILD_CONFIG='${BUILD_CONFIG}'"
      echo "DEBUG: PROJECT_ROOT='${PROJECT_ROOT}'"

      APP_PATH="$PROJECT_ROOT/.devbox/virtenv/ios/DerivedData/Build/Products/${BUILD_CONFIG}-iphonesimulator/ReactNativeExample.app"
      echo "DEBUG: APP_PATH='${APP_PATH}'"

      if [ ! -d "$APP_PATH" ]; then
        echo "ERROR: App bundle not found at $APP_PATH" >&2
        echo "ERROR: BUILD_CONFIG was: '${BUILD_CONFIG}'" >&2
        echo "ERROR: Contents of Products directory:" >&2
        ls -la "$PROJECT_ROOT/.devbox/virtenv/ios/DerivedData/Build/Products/" >&2 || true
        exit 1
      fi

      xcrun simctl install "$DEVICE_UDID" "$APP_PATH"

      # Launch app with Metro port environment variable
      echo "Launching app with Metro on port $METRO_PORT..."
      xcrun simctl launch "$DEVICE_UDID" "${IOS_APP_BUNDLE_ID}" \
        RCT_METRO_PORT="$METRO_PORT"

      echo "âœ“ App deployed and launched successfully"
    depends_on:
      install-pods:
        condition: process_completed_successfully
      ios-simulator:
        condition: process_completed_successfully
    availability:
      restart: "no"

  # Phase 7: Verify app is running
  verify-app-running:
    command: |
      if [ "${DEVBOX_PURE_SHELL:-}" = "1" ]; then
        DEVICE_UDID=$(xcrun simctl list devices | grep "Test" | grep "Booted" | grep -oE '[0-9A-F-]{36}' | head -1)
      else
        DEVICE_UDID=$(xcrun simctl list devices | grep "Booted" | grep -oE '[0-9A-F-]{36}' | head -1)
      fi

      echo "Waiting for app to start..."
      max_attempts=10
      attempt=0
      while [ $attempt -lt $max_attempts ]; do
        if xcrun simctl spawn "$DEVICE_UDID" launchctl list | grep -q "${IOS_APP_BUNDLE_ID}"; then
          echo "âœ“ App is running: ${IOS_APP_BUNDLE_ID}"
          exit 0
        fi
        attempt=$((attempt + 1))
        echo "  Attempt $attempt/$max_attempts..."
        sleep 2
      done

      echo "ERROR: App did not start within timeout" >&2
      exit 1
    depends_on:
      deploy-ios:
        condition: process_completed_successfully
    availability:
      restart: "no"

  # Cleanup - runs after verify completes OR after timeout
  cleanup:
    command: |
      # Wait for verify-app-running to complete (or timeout after 5 minutes)
      max_wait=300
      waited=0
      while [ $waited -lt $max_wait ]; do
        # Check if verify-app-running process exists and completed
        # (We can't easily check process status in shell, so just wait a reasonable time)
        sleep 1
        waited=$((waited + 1))
      done

      # Note: Process-compose will automatically kill Metro when tests complete
      # Don't delete Metro state files here - Metro may restart and need them

      if [ "${DEVBOX_PURE_SHELL:-}" = "1" ]; then
        echo "ðŸ§¹ Cleaning up (pure mode)..."

        test_sim_udid=$(cat .devbox/virtenv/ios/runtime/simulator-udid.txt 2>/dev/null || echo "")

        if [ -z "$test_sim_udid" ]; then
          test_sim_udid=$(xcrun simctl list devices | grep "Test" | grep -oE '[0-9A-F-]{36}' | head -1 || echo "")
        fi

        if [ -n "$test_sim_udid" ]; then
          xcrun simctl terminate "$test_sim_udid" "${IOS_APP_BUNDLE_ID}" 2>/dev/null || true
          xcrun simctl shutdown "$test_sim_udid" 2>/dev/null || true
          xcrun simctl delete "$test_sim_udid" 2>/dev/null || true
          rm -f .devbox/virtenv/ios/runtime/simulator-udid.txt 2>/dev/null || true
          echo "âœ“ App stopped, test simulator deleted"
        else
          echo "âœ“ No test simulator to clean up"
        fi
      else
        echo "âœ“ Test complete - app and simulator still running"
      fi
    depends_on:
      allocate-metro-port:
        condition: process_completed_successfully
      ios-simulator:
        condition: process_completed_successfully
    availability:
      restart: "no"

  # Summary - displays results and optionally stays open
  summary:
    command: "bash tests/test-summary.sh 'React Native iOS E2E Test Suite' 'reports/react-native-ios-e2e-logs'"
    depends_on:
      cleanup:
        condition: process_completed
    availability:
      restart: "no"
    shutdown:
      signal: 15
      timeout_seconds: 1
