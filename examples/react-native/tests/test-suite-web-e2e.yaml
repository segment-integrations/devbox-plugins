version: "0.5"

environment:
  - "TEST_TUI=false"
  - "WEB_PORT=8081"
  - "TEST_TIMEOUT=60"

log_location: "reports/react-native-web-e2e-logs"
log_level: info
is_strict: false

processes:
  # Phase 0: Allocate Metro port
  allocate-metro-port:
    command: |
      # Source React Native lib
      . ${REACT_NATIVE_VIRTENV}/scripts/lib/lib.sh

      # Allocate port for web test suite
      metro_port=$(rn_allocate_metro_port "web")
      echo "ðŸ“¡ Allocated Metro port: $metro_port"

      # Save environment file for other processes
      env_file=$(rn_save_metro_env "web" "$metro_port")
      echo "âœ“ Metro environment saved to: $env_file"
    availability:
      restart: "no"

  # Phase 1: Build Node dependencies
  build-node:
    depends_on:
      allocate-metro-port:
        condition: process_completed_successfully
    command: "devbox run --pure build:node"
    availability:
      restart: "no"

  # Phase 2: Build web bundle directory
  build-web:
    command: |
      echo 'ðŸ“¦ Creating web build directory...'
      mkdir -p web/build
      echo 'âœ“ Web build directory ready'
    depends_on:
      build-node:
        condition: process_completed_successfully
    availability:
      restart: "no"

  # Phase 3: Start Metro bundler
  metro-bundler:
    command: "metro.sh start web"
    depends_on:
      allocate-metro-port:
        condition: process_completed_successfully
      build-node:
        condition: process_completed_successfully
    availability:
      restart: "no"
    shutdown:
      command: "metro.sh stop web || true"
      signal: 15
      timeout_seconds: 5
    readiness_probe:
      exec:
        command: "metro.sh health web ios"
      initial_delay_seconds: 5
      period_seconds: 5
      timeout_seconds: 60
      success_threshold: 1

  # Phase 4: Open browser with web bundle
  open-browser:
    command: |
      # Source Metro environment to get correct port
      . ${REACT_NATIVE_VIRTENV}/metro/env-web.sh

      echo "ðŸŒ Opening browser to Metro web bundle..."
      echo "   URL: http://localhost:$METRO_PORT"

      # Open default browser
      if command -v open >/dev/null 2>&1; then
        # macOS
        open "http://localhost:$METRO_PORT"
      elif command -v xdg-open >/dev/null 2>&1; then
        # Linux
        xdg-open "http://localhost:$METRO_PORT"
      elif command -v start >/dev/null 2>&1; then
        # Windows (Git Bash/WSL)
        start "http://localhost:$METRO_PORT"
      else
        echo "âš  Could not detect browser launcher"
        echo "   Please open: http://localhost:$METRO_PORT"
      fi

      echo "âœ“ Browser launched"
      echo ""
      echo "Metro is running at: http://localhost:$METRO_PORT"
      echo "Press Ctrl+C to stop Metro and exit"
    depends_on:
      metro-bundler:
        condition: process_healthy
    availability:
      restart: "no"

  # Cleanup
  cleanup:
    command: |
      # Stop Metro bundler explicitly
      echo "Stopping Metro bundler..."
      metro.sh stop web || true

      # Also kill the metro.sh wrapper process
      pkill -f "metro.sh start web" || true

      echo "âœ“ Test complete"
    depends_on:
      open-browser:
        condition: process_completed
      metro-bundler:
        condition: process_healthy
    availability:
      restart: "no"

  # Summary - displays results and optionally stays open
  summary:
    command: "bash tests/test-summary.sh 'React Native Web E2E Test Suite' 'reports/react-native-web-e2e-logs'"
    depends_on:
      cleanup:
        condition: process_completed
    availability:
      restart: "no"
    shutdown:
      signal: 15
      timeout_seconds: 1
