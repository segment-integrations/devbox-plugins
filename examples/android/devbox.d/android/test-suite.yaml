version: "0.5"

environment:
  - "TEST_TIMEOUT=300"
  - "BOOT_TIMEOUT=180"

log_location: "test-results/android-e2e-logs"
log_level: info

processes:
  # Phase 1: Build - runs first (no dependency)
  build-app:
    command: "echo 'ðŸ“¦ Building Android app...' && gradle assembleDebug --info && echo 'âœ“ Build complete'"
    availability:
      restart: "no"
    readiness_probe:
      exec:
        command: "test -f ${ANDROID_APP_APK:-app/build/outputs/apk/debug/app-debug.apk}"
      initial_delay_seconds: 5
      period_seconds: 5
      timeout_seconds: 300
      success_threshold: 1

  # Phase 2a: Sync AVDs - ensure all AVDs match device definitions
  sync-avds:
    command: "echo 'ðŸ”„ Syncing AVDs with device definitions...' && android.sh devices sync && echo 'âœ“ Sync complete'"
    availability:
      restart: "no"
    readiness_probe:
      exec:
        command: "echo 'Sync complete'"
      initial_delay_seconds: 1
      period_seconds: 2
      timeout_seconds: 120
      success_threshold: 1

  # Phase 2b: Start emulator (depends on sync completing)
  # Reuses existing emulator if already running
  # Max boot time: 5 minutes, 1 retry allowed, total timeout: 10 minutes
  android-emulator:
    depends_on:
      sync-avds:
        condition: process_completed_successfully
    command: |
      # Detect running emulator or start new one
      # Set TEST_PURE=1 to always start fresh with clean state (for deterministic testing)
      if [ "${TEST_PURE:-0}" = "1" ]; then
        echo "ðŸš€ Starting fresh Android emulator with clean state (${ANDROID_DEFAULT_DEVICE:-max})..."

        # Capture output and extract serial
        output=$(android.sh emulator start --pure ${ANDROID_DEFAULT_DEVICE:-max} 2>&1)
        echo "$output"

        # Extract serial from output (looks for "emulator-XXXX" pattern)
        serial=$(echo "$output" | grep -o 'emulator-[0-9]*' | head -1)
        export ANDROID_SERIAL="${serial:-emulator-5554}"
        echo "âœ“ Using emulator: $ANDROID_SERIAL"
      else
        existing_emu=$(adb devices | grep emulator | head -1 | awk '{print $1}')

        if [ -n "$existing_emu" ]; then
          echo "âœ“ Reusing existing running emulator: $existing_emu"
          export ANDROID_SERIAL="$existing_emu"
        else
          echo "ðŸš€ Starting Android emulator (${ANDROID_DEFAULT_DEVICE:-max})..."

          # Capture output and extract serial
          output=$(android.sh emulator start ${ANDROID_DEFAULT_DEVICE:-max} 2>&1)
          echo "$output"

          # Extract serial from output
          serial=$(echo "$output" | grep -o 'emulator-[0-9]*' | head -1)
          export ANDROID_SERIAL="${serial:-emulator-5554}"
          echo "âœ“ Using emulator: $ANDROID_SERIAL"
        fi
      fi

      # Write serial to file for other processes to read
      echo "$ANDROID_SERIAL" > /tmp/android-emu-serial.txt
      echo "âœ“ Emulator ready for testing"
    availability:
      restart: "no"

  # Phase 3: Deploy app - depends on both build and emulator being ready
  deploy-app:
    command: |
      serial=$(cat /tmp/android-emu-serial.txt 2>/dev/null || echo emulator-5554)
      export ANDROID_EMULATOR_SERIAL="$serial"

      echo "ðŸ“² Deploying app to emulator: $serial"
      android.sh deploy

      echo ""
      echo "Waiting for app to start..."
      max_attempts=10
      attempt=0
      while [ $attempt -lt $max_attempts ]; do
        if adb -s $serial shell pidof ${ANDROID_APP_ID:-com.example.devbox} >/dev/null 2>&1; then
          echo "âœ“ App process running (PID: $(adb -s $serial shell pidof ${ANDROID_APP_ID:-com.example.devbox}))"
          exit 0
        fi
        attempt=$((attempt + 1))
        echo "  Attempt $attempt/$max_attempts..."
        sleep 2
      done

      echo "ERROR: App did not start within timeout" >&2
      echo "Installed packages:" >&2
      adb -s $serial shell pm list packages | grep -i devbox || true
      echo "Running processes:" >&2
      adb -s $serial shell ps | grep -i devbox || true
      exit 1
    depends_on:
      build-app:
        condition: process_completed_successfully
      android-emulator:
        condition: process_completed_successfully
    availability:
      restart: "no"

  # Cleanup - stop the app (and emulator if TEST_PURE=1)
  cleanup-app:
    command: |
      serial=$(cat /tmp/android-emu-serial.txt 2>/dev/null || echo emulator-5554)
      echo "ðŸ§¹ Cleaning up: stopping app on $serial"
      adb -s $serial shell am force-stop ${ANDROID_APP_ID:-com.example.devbox} 2>/dev/null || true

      # If TEST_PURE=1, also stop the emulator
      if [ "${TEST_PURE:-0}" = "1" ]; then
        echo "Stopping emulator (pure mode)..."
        android.sh emulator stop || true
        echo "âœ“ App stopped, emulator stopped"
      else
        echo "âœ“ App stopped (emulator still running)"
      fi
    depends_on:
      deploy-app:
        condition: process_completed_successfully
    availability:
      restart: "no"

  # Summary - displays results and optionally stays open
  summary:
    command: "bash ${ANDROID_FLAKE_DIR}/test-summary.sh 'Android E2E Test Suite' 'test-results/android-e2e-logs'"
    depends_on:
      cleanup-app:
        condition: process_completed
    availability:
      restart: "no"
    shutdown:
      signal: 15
      timeout_seconds: 1
