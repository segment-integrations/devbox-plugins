version: "0.5"

environment:
  - "TEST_TIMEOUT=300"
  - "BOOT_TIMEOUT=90"
  - "TEST_TUI=false"
  - "ANDROID_DEBUG_SETUP=${ANDROID_DEBUG_SETUP:-}"

log_location: "reports/android-e2e-logs"
log_level: info

processes:
  # Phase 1: Build - runs first (no dependency)
  build-app:
    command: |
      echo '[BUILD-APP] Starting build process (PID=$$)...'
      # Source Android environment to set ANDROID_SDK_ROOT
      . ${ANDROID_RUNTIME_DIR}/scripts/init/setup.sh
      echo 'ðŸ“¦ Building Android app...'
      gradle assembleDebug --info
      echo 'âœ“ Build complete'
    availability:
      restart: "no"

  # Phase 2a: Sync AVDs - ensure all AVDs match device definitions
  sync-avds:
    command: "echo '[SYNC-AVDS] Starting (PID=$$)...' && echo '[SYNC-AVDS] About to source setup.sh...' && . ${ANDROID_RUNTIME_DIR}/scripts/init/setup.sh && echo '[SYNC-AVDS] setup.sh sourced' && echo 'ðŸ”„ Syncing AVDs with device definitions...' && android.sh devices sync && echo 'âœ“ Sync complete'"
    availability:
      restart: "no"

  # Phase 2b: Start emulator (depends on sync completing)
  # Reuses existing emulator if already running
  # Max boot time: 5 minutes, 1 retry allowed, total timeout: 10 minutes
  android-emulator:
    depends_on:
      sync-avds:
        condition: process_completed_successfully
    environment:
      - "ANDROID_EMULATOR_FOREGROUND=1"  # Run emulator in foreground for process-compose monitoring
    command: |
      echo "[ANDROID-EMULATOR] Starting emulator in foreground mode..."
      # Source Android environment
      . ${ANDROID_RUNTIME_DIR}/scripts/init/setup.sh

      # Determine which device to start
      device="${ANDROID_DEFAULT_DEVICE:-max}"

      # In pure mode, always start fresh
      if [ "${IN_NIX_SHELL:-}" = "pure" ]; then
        echo "ðŸš€ Starting fresh Android emulator (pure mode): $device"
        export ANDROID_EMULATOR_PURE=1

        # Write expected serial for readiness probe (emulator always starts on 5554 first)
        echo "emulator-5554" > ${ANDROID_RUNTIME_DIR}/emulator-serial.txt

        # Start emulator in foreground - this blocks and runs the emulator
        # Process-compose will monitor it and use readiness probe to check when ready
        android.sh emulator start "$device"
      else
        echo "ðŸš€ Verifying Android emulator is running: $device"

        # Write expected serial for readiness probe
        serial="emulator-5554"
        echo "$serial" > ${ANDROID_RUNTIME_DIR}/emulator-serial.txt

        # Check if emulator is already running
        if adb devices | grep -q "$serial"; then
          echo "âœ“ Emulator already running: $serial"
        else
          echo "Starting emulator in background: $device"
          # Start emulator in background (no foreground mode for reuse)
          unset ANDROID_EMULATOR_FOREGROUND
          android.sh emulator start "$device" &
          echo "âœ“ Emulator starting (PID: $!)"
        fi

        # Wait for emulator to be fully booted
        echo "Waiting for emulator to boot..."
        max_attempts=60
        attempt=0
        while [ $attempt -lt $max_attempts ]; do
          if adb -s $serial shell getprop sys.boot_completed 2>/dev/null | grep -q "1"; then
            echo "âœ“ Emulator ready for testing"
            break
          fi
          attempt=$((attempt + 1))
          sleep 2
        done

        if [ $attempt -ge $max_attempts ]; then
          echo "ERROR: Emulator did not boot within timeout"
          exit 1
        fi

        # Let process complete - emulator stays running in background
        echo "âœ“ Emulator will remain running after tests complete"
        exit 0
      fi
    availability:
      restart: "no"
    readiness_probe:
      exec:
        command: |
          serial=$(cat ${ANDROID_RUNTIME_DIR}/emulator-serial.txt 2>/dev/null || echo "")
          [ -n "$serial" ] && adb -s $serial shell getprop sys.boot_completed 2>/dev/null | grep -q "1"
      initial_delay_seconds: 10
      period_seconds: 10
      timeout_seconds: 180
      success_threshold: 1
      failure_threshold: 12

  # Phase 3: Run app - depends on both build and emulator being ready
  run-app:
    command: |
      # Source Android environment
      . ${ANDROID_RUNTIME_DIR}/scripts/init/setup.sh

      serial=$(cat ${ANDROID_RUNTIME_DIR}/emulator-serial.txt 2>/dev/null || echo emulator-5554)
      export ANDROID_EMULATOR_SERIAL="$serial"

      echo "ðŸ“² Running app on emulator: $serial"
      # Use already-built APK from build-app phase
      android.sh run ${ANDROID_APP_APK:-app/build/outputs/apk/debug/app-debug.apk}

      echo ""
      echo "Waiting for app to start..."
      max_attempts=10
      attempt=0
      while [ $attempt -lt $max_attempts ]; do
        if adb -s $serial shell pidof ${ANDROID_APP_ID:-com.example.devbox} >/dev/null 2>&1; then
          echo "âœ“ App process running (PID: $(adb -s $serial shell pidof ${ANDROID_APP_ID:-com.example.devbox}))"
          exit 0
        fi
        attempt=$((attempt + 1))
        echo "  Attempt $attempt/$max_attempts..."
        sleep 2
      done

      echo "ERROR: App did not start within timeout" >&2
      echo "Installed packages:" >&2
      adb -s $serial shell pm list packages | grep -i devbox || true
      echo "Running processes:" >&2
      adb -s $serial shell ps | grep -i devbox || true
      exit 1
    depends_on:
      build-app:
        condition: process_completed_successfully
      android-emulator:
        condition: process_completed_successfully
    availability:
      restart: "no"

  # Cleanup - stop everything in pure mode, keep running in dev mode
  cleanup-app:
    command: |
      # Source Android environment
      . ${ANDROID_RUNTIME_DIR}/scripts/init/setup.sh

      serial=$(cat ${ANDROID_RUNTIME_DIR}/emulator-serial.txt 2>/dev/null || echo emulator-5554)

      # In pure mode (CI), stop app and emulator for reproducibility
      if [ "${IN_NIX_SHELL:-}" = "pure" ]; then
        echo "ðŸ§¹ Cleaning up (pure mode): stopping app and emulator..."
        adb -s $serial shell am force-stop ${ANDROID_APP_ID:-com.example.devbox} 2>/dev/null || true
        android.sh emulator stop || true
        echo "âœ“ App stopped, emulator stopped"
      else
        # In dev mode, keep app and emulator running for interaction
        echo "âœ“ Test complete - app and emulator still running"
      fi
    depends_on:
      run-app:
        condition: process_completed_successfully
    availability:
      restart: "no"

  # Summary - displays results and optionally stays open
  summary:
    command: |
      bash tests/test-summary.sh 'Android E2E Test Suite' 'reports/android-e2e-logs'
      exit 0
    depends_on:
      cleanup-app:
        condition: process_completed
    availability:
      restart: "no"
    shutdown:
      signal: 15
      timeout_seconds: 1
