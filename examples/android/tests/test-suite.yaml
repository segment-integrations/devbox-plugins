version: "0.5"

environment:
  - "TEST_TIMEOUT=300"
  - "BOOT_TIMEOUT=180"
  - "ANDROID_DEBUG_SETUP=${ANDROID_DEBUG_SETUP:-}"

log_location: "reports/android-e2e-logs"
log_level: info

processes:
  # Phase 1: Build - runs first (no dependency)
  build-app:
    command: "echo '[BUILD-APP] Starting build process (PID=$$)...' && echo 'ðŸ“¦ Building Android app...' && gradle assembleDebug --info && echo 'âœ“ Build complete'"
    availability:
      restart: "no"

  # Phase 2a: Sync AVDs - ensure all AVDs match device definitions
  sync-avds:
    command: "echo '[SYNC-AVDS] Starting (PID=$$)...' && echo '[SYNC-AVDS] About to source setup.sh...' && . ${ANDROID_FLAKE_DIR}/scripts/init/setup.sh && echo '[SYNC-AVDS] setup.sh sourced' && echo 'ðŸ”„ Syncing AVDs with device definitions...' && android.sh devices sync && echo 'âœ“ Sync complete'"
    availability:
      restart: "no"

  # Phase 2b: Start emulator (depends on sync completing)
  # Reuses existing emulator if already running
  # Max boot time: 5 minutes, 1 retry allowed, total timeout: 10 minutes
  android-emulator:
    depends_on:
      sync-avds:
        condition: process_completed_successfully
    command: |
      echo "[ANDROID-EMULATOR] Starting (PID=$$)..."
      # Source Android environment
      echo "[ANDROID-EMULATOR] About to source setup.sh..."
      . ${ANDROID_FLAKE_DIR}/scripts/init/setup.sh
      echo "[ANDROID-EMULATOR] setup.sh sourced"
      echo "DEBUG: Setup sourced, checking PATH..."
      echo "DEBUG: android.sh location: $(which android.sh 2>&1 || echo 'NOT FOUND')"

      # Detect running emulator or start new one
      # Set TEST_PURE=1 to always start fresh with clean state (for deterministic testing)
      if [ "${TEST_PURE:-0}" = "1" ]; then
        echo "ðŸš€ Starting fresh Android emulator with clean state (${ANDROID_DEFAULT_DEVICE:-max})..."
        echo "DEBUG: About to call android.sh emulator start..."

        # Run emulator start command (outputs to console in real-time)
        android.sh emulator start --pure ${ANDROID_DEFAULT_DEVICE:-max}

        # Read serial from temp file written by emulator.sh
        export ANDROID_SERIAL=$(cat /tmp/android-emulator-serial.txt)
        echo "âœ“ Using emulator: $ANDROID_SERIAL"
      else
        existing_emu=$(adb devices | grep emulator | head -1 | awk '{print $1}')

        if [ -n "$existing_emu" ]; then
          echo "âœ“ Reusing existing running emulator: $existing_emu"
          export ANDROID_SERIAL="$existing_emu"
        else
          echo "ðŸš€ Starting Android emulator (${ANDROID_DEFAULT_DEVICE:-max})..."

          # Run emulator start command (outputs to console in real-time)
          android.sh emulator start ${ANDROID_DEFAULT_DEVICE:-max}

          # Read serial from temp file written by emulator.sh
          export ANDROID_SERIAL=$(cat /tmp/android-emulator-serial.txt)
          echo "âœ“ Using emulator: $ANDROID_SERIAL"
        fi
      fi

      # Write serial to file for other processes to read
      echo "$ANDROID_SERIAL" > /tmp/android-emu-serial.txt
      echo "âœ“ Emulator ready for testing"

      # Keep process alive so emulator stays running
      tail -f /dev/null
    availability:
      restart: "no"
    readiness_probe:
      exec:
        command: |
          serial=$(cat /tmp/android-emu-serial.txt 2>/dev/null || echo "")
          [ -n "$serial" ] && adb -s $serial shell getprop sys.boot_completed 2>/dev/null | grep -q "1"
      initial_delay_seconds: 10
      period_seconds: 5
      timeout_seconds: 180
      success_threshold: 1
      failure_threshold: 3

  # Phase 3: Deploy app - depends on both build and emulator being ready
  deploy-app:
    command: |
      # Source Android environment
      . ${ANDROID_FLAKE_DIR}/scripts/init/setup.sh

      serial=$(cat /tmp/android-emu-serial.txt 2>/dev/null || echo emulator-5554)
      export ANDROID_EMULATOR_SERIAL="$serial"

      echo "ðŸ“² Deploying app to emulator: $serial"
      android.sh deploy

      echo ""
      echo "Waiting for app to start..."
      max_attempts=10
      attempt=0
      while [ $attempt -lt $max_attempts ]; do
        if adb -s $serial shell pidof ${ANDROID_APP_ID:-com.example.devbox} >/dev/null 2>&1; then
          echo "âœ“ App process running (PID: $(adb -s $serial shell pidof ${ANDROID_APP_ID:-com.example.devbox}))"
          exit 0
        fi
        attempt=$((attempt + 1))
        echo "  Attempt $attempt/$max_attempts..."
        sleep 2
      done

      echo "ERROR: App did not start within timeout" >&2
      echo "Installed packages:" >&2
      adb -s $serial shell pm list packages | grep -i devbox || true
      echo "Running processes:" >&2
      adb -s $serial shell ps | grep -i devbox || true
      exit 1
    depends_on:
      build-app:
        condition: process_completed_successfully
      android-emulator:
        condition: process_healthy
    availability:
      restart: "no"

  # Cleanup - stop the app (and emulator if TEST_PURE=1)
  cleanup-app:
    command: |
      # Source Android environment
      . ${ANDROID_FLAKE_DIR}/scripts/init/setup.sh

      serial=$(cat /tmp/android-emu-serial.txt 2>/dev/null || echo emulator-5554)
      echo "ðŸ§¹ Cleaning up: stopping app on $serial"
      adb -s $serial shell am force-stop ${ANDROID_APP_ID:-com.example.devbox} 2>/dev/null || true

      # If TEST_PURE=1, also stop the emulator
      if [ "${TEST_PURE:-0}" = "1" ]; then
        echo "Stopping emulator (pure mode)..."
        android.sh emulator stop || true
        echo "âœ“ App stopped, emulator stopped"
      else
        echo "âœ“ App stopped (emulator still running)"
      fi
    depends_on:
      deploy-app:
        condition: process_completed_successfully
    availability:
      restart: "no"

  # Summary - displays results and optionally stays open
  summary:
    command: "bash tests/test-summary.sh 'Android E2E Test Suite' 'reports/android-e2e-logs'"
    depends_on:
      cleanup-app:
        condition: process_completed
    availability:
      restart: "no"
    shutdown:
      signal: 15
      timeout_seconds: 1
