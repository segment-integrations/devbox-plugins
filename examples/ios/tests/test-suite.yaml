version: "0.5"

environment:
  - "IOS_DEVICE=${IOS_DEFAULT_DEVICE:-max}"
  - "TEST_TIMEOUT=300"
  - "BOOT_TIMEOUT=120"

log_location: "/tmp/ios-e2e-logs"
log_level: info

processes:
  # Phase 1: Build app - runs first
  build-app:
    command: "devbox run --pure build"
    availability:
      restart: "no"

  # Phase 2: Sync simulators - ensure all simulators match device definitions
  sync-simulators:
    command: "devbox run ios.sh devices sync"
    availability:
      restart: "no"

  # Phase 3: Start simulator - depends on sync completing
  ios-simulator:
    command: |
      # In pure mode (IN_NIX_SHELL=pure), start fresh simulator with clean state
      # Otherwise, reuse existing simulator if available
      if [ "${IN_NIX_SHELL:-}" = "pure" ]; then
        echo "ðŸš€ Starting fresh iOS simulator with clean state (${IOS_DEVICE})..."
        devbox run start:sim ${IOS_DEVICE} --pure
      else
        # Check if simulator is already running
        existing_udid=$(xcrun simctl list devices | grep "${IOS_DEVICE}" | grep "Booted" | grep -oE '[0-9A-F-]{36}' | head -1 || true)
        if [ -n "$existing_udid" ]; then
          echo "âœ“ Reusing existing running simulator: ${IOS_DEVICE} ($existing_udid)"
        else
          echo "ðŸš€ Starting iOS simulator (${IOS_DEVICE})..."
          devbox run start:sim ${IOS_DEVICE}
        fi
      fi
      echo "âœ“ Simulator ready for testing"

      # Keep process alive so simulator stays running
      tail -f /dev/null
    depends_on:
      sync-simulators:
        condition: process_completed_successfully
    availability:
      restart: "no"
    readiness_probe:
      exec:
        command: |
          DEVICE_UDID=$(xcrun simctl list devices | grep "${IOS_DEVICE}" | grep "Booted" | grep -oE '[0-9A-F-]{36}' | head -1 || echo "")
          [ -n "$DEVICE_UDID" ] && xcrun simctl bootstatus "$DEVICE_UDID" >/dev/null 2>&1
      initial_delay_seconds: 10
      period_seconds: 5
      timeout_seconds: 120
      success_threshold: 1
      failure_threshold: 3

  # Phase 4: Deploy app - depends on both build and simulator
  deploy-app:
    command: "devbox run --pure start:ios ${IOS_DEVICE}"
    depends_on:
      build-app:
        condition: process_completed_successfully
      ios-simulator:
        condition: process_healthy
    availability:
      restart: "no"
    readiness_probe:
      exec:
        command: |
          DEVICE_UDID=$(xcrun simctl list devices | grep ${IOS_DEVICE} | grep -oE '[0-9A-F-]{36}' | head -1)
          xcrun simctl get_app_container "$DEVICE_UDID" "${IOS_APP_BUNDLE_ID:-com.example.ios}" >/dev/null 2>&1
      initial_delay_seconds: 5
      period_seconds: 3
      timeout_seconds: 60
      success_threshold: 1

  # Phase 5: Verify app is running
  verify-app-running:
    command: |
      DEVICE_UDID=$(xcrun simctl list devices | grep ${IOS_DEVICE} | grep -oE '[0-9A-F-]{36}' | head -1)
      xcrun simctl spawn "$DEVICE_UDID" launchctl list | grep -q "${IOS_APP_BUNDLE_ID:-com.example.ios}"
    depends_on:
      deploy-app:
        condition: process_completed_successfully
    availability:
      restart: "no"
    readiness_probe:
      exec:
        command: |
          DEVICE_UDID=$(xcrun simctl list devices | grep ${IOS_DEVICE} | grep -oE '[0-9A-F-]{36}' | head -1)
          xcrun simctl spawn "$DEVICE_UDID" launchctl list | grep -q "${IOS_APP_BUNDLE_ID:-com.example.ios}"
      initial_delay_seconds: 2
      period_seconds: 3
      timeout_seconds: 30
      success_threshold: 1

  # Cleanup - stop everything in pure mode, keep running in dev mode
  cleanup:
    command: |
      # In pure mode (CI), delete the test simulator for reproducibility
      if [ "${IN_NIX_SHELL:-}" = "pure" ]; then
        echo "ðŸ§¹ Cleaning up (pure mode): deleting test simulator..."
        # Find and delete any simulator with "Test" suffix
        test_sim_udid=$(xcrun simctl list devices | grep "Test" | grep -oE '[0-9A-F-]{36}' | head -1 || true)
        if [ -n "$test_sim_udid" ]; then
          xcrun simctl shutdown "$test_sim_udid" >/dev/null 2>&1 || true
          xcrun simctl delete "$test_sim_udid" >/dev/null 2>&1 || true
          echo "âœ“ Test simulator deleted"
        else
          echo "âœ“ No test simulator to clean up"
        fi
      else
        # In dev mode, keep app and simulator running for interaction
        echo "âœ“ Test complete - app and simulator still running"
      fi
    depends_on:
      verify-app-running:
        condition: process_completed
    availability:
      restart: "no"

  # Summary - displays results and optionally stays open
  summary:
    command: "bash tests/test-summary.sh 'iOS E2E Test Suite' '/tmp/ios-e2e-logs'"
    depends_on:
      cleanup:
        condition: process_completed
    availability:
      restart: "no"
    shutdown:
      signal: 15
      timeout_seconds: 1
