version = 1

[install]
gradle.pkg-path = "gradle"
jdk17.pkg-path = "jdk17"
jq.pkg-path = "jq"

[vars]
ANDROID_SYSTEM_IMAGE_TAG = "google_apis"
ANDROID_EMULATOR_FLAGS = "-no-boot-anim -netdelay none -netspeed full -no-snapshot -camera-back none -camera-front none"
ANDROID_EMULATOR_HEADLESS_FLAGS = "-no-window -no-audio -gpu swiftshader_indirect"

[hook]
 on-activate = '''
  export PROJECT_ROOT="${PROJECT_ROOT:-$(git rev-parse --show-toplevel 2>/dev/null || pwd)}"

  env_project="${FLOX_ENV_PROJECT:-}"
  lock_path=""
  if [ -n "$env_project" ]; then
    lock_path="$env_project/.flox/env/manifest.lock"
  fi

  if [ -z "$lock_path" ] || [ ! -f "$lock_path" ]; then
    echo "Android SDK lockfile not found. Ensure the env is initialized." >&2
    exit 1
  fi

  if ! command -v jq >/dev/null 2>&1; then
    echo "jq is required to locate the pinned Android SDK." >&2
    exit 1
  fi

  sdk_out="$(jq -r '.packages[] | select(.name|test("android-sdk|androidsdk")) | .outputs.out // empty' "$lock_path" | head -n 1)"
  if [ -z "$sdk_out" ]; then
    echo "Pinned Android SDK not found in manifest.lock." >&2
    exit 1
  fi

  sdk_root="${sdk_out}/libexec/android-sdk"
  if [ ! -d "$sdk_root/platform-tools" ]; then
    echo "Pinned Android SDK missing platform-tools at ${sdk_root}." >&2
    exit 1
  fi

  export ANDROID_SDK_ROOT="$sdk_root"
  export ANDROID_HOME="$sdk_root"

  export PATH="${ANDROID_SDK_ROOT}/platform-tools:${ANDROID_SDK_ROOT}/emulator:$PATH"
  if [ -d "${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin" ]; then
    export PATH="${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin:$PATH"
  fi

  if [ -z "${ANDROID_ENV_INFO_PRINTED:-}" ]; then
    build_tools=""
    if [ -d "${ANDROID_SDK_ROOT}/build-tools" ]; then
      build_tools="$(ls -1 "${ANDROID_SDK_ROOT}/build-tools" 2>/dev/null | sort -V | tail -n 1)"
    fi
    adb_version=""
    if command -v adb >/dev/null 2>&1; then
      adb_version="$(adb version 2>/dev/null | head -n 1)"
    fi
    echo
    echo "Android env:"
    echo "  ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT:-}"
    echo "  ANDROID_HOME=${ANDROID_HOME:-}"
    echo "  Build tools=${build_tools:-unknown}"
    if [ -n "$adb_version" ]; then
      echo "  ${adb_version}"
    fi
    echo "  ANDROID_API=${ANDROID_API:-}"
    echo
    ANDROID_ENV_INFO_PRINTED=1
  fi
 '''

[profile]
bash = '''
  android_reset() {
    rm -rf "${ANDROID_AVD_HOME:-$HOME/.android/avd}" "$HOME/.android/adbkey" "$HOME/.android/adbkey.pub"
    echo "Android AVDs and adb keys removed."
  }
  alias android-reset=android_reset
'''

zsh = '''
  android_reset() {
    rm -rf "${ANDROID_AVD_HOME:-$HOME/.android/avd}" "$HOME/.android/adbkey" "$HOME/.android/adbkey.pub"
    echo "Android AVDs and adb keys removed."
  }
  alias android-reset=android_reset
'''

[services]

[include]
environments = []

[build]

[options]
